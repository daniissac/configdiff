name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install hypothesis

      - name: Run unit and integration tests
        run: |
          pytest tests/ \
            --tb=short \
            -v \
            --junitxml=results/junit.xml \
            --cov=configdiff \
            --cov-report=term-missing \
            --cov-report=xml:results/coverage.xml

      - name: Verify CLI entry point
        run: |
          configdiff --version
          configdiff --help

      - name: Smoke test — JSON diff (exit 1 = changes found)
        run: |
          set +e
          configdiff examples/before.json examples/after.json --format json
          EXIT_CODE=$?
          set -e
          test "$EXIT_CODE" -eq 1

      - name: Smoke test — YAML diff (exit 1 = changes found)
        run: |
          set +e
          configdiff examples/before.yaml examples/after.yaml --format text
          EXIT_CODE=$?
          set -e
          test "$EXIT_CODE" -eq 1

      - name: Smoke test — exit code 0 on identical files
        run: configdiff examples/before.json examples/before.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: results/
          retention-days: 30

  golden-check:
    name: Golden file regression
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        run: pip install -e ".[dev]"

      - name: Verify golden files match
        run: pytest tests/test_golden.py -v --tb=long

  quality-report:
    name: Quality report
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install
        run: |
          pip install -e ".[dev]"
          pip install hypothesis

      - name: Generate validation report
        run: |
          python tests/generate_report.py

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: results/validation_report.md
          retention-days: 90
